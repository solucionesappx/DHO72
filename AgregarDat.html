<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicaci√≥n M√≥vil - DHO Vacaciones</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Configuraci√≥n de Tailwind para usar el color de acento y la fuente Inter ¬†*/
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Definici√≥n de colores base ¬†*/
        :root {
            --color-bg-dark: #1f2937;
            --color-text-dark: #f3f4f6; /* Color de texto claro general */
            --color-primary-dark: #60a5fa; /* Azul claro para acento */
            --color-surface-dark: #374151; /* Gris oscuro para header/footer */
            --color-form-bg: #2d3748; /* Fondo m√°s oscuro para el cuerpo del formulario */
            --color-input-bg: #4a5568; /* Fondo del input */
            --color-label-gray: #d1d5db; /* Equivalente a Tailwind text-gray-300 */
        }
        
        /* Estilos del cuerpo en modo oscuro */
        .dark { background-color: var(--color-bg-dark); color: var(--color-text-dark); }
        
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            position: relative; 
            overflow: hidden; 
        }

        header, footer {
            width: 100%;
            max-width: 500px; 
            z-index: 50; 
            transition: background-color 0.3s, color 0.3s;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Estilos espec√≠ficos para header y footer en modo oscuro */
        .dark header, .dark footer { 
            background-color: var(--color-surface-dark); 
            border-color: #4b5563; 
        }

        main {
            flex-grow: 1;
            overflow-y: auto; 
            padding-left: 1rem;
            padding-right: 1rem;
            transition: padding 0.3s ease-in-out;
            padding-top: 56px; /* Para compensar la altura del header (h-14 = 56px) */
            padding-bottom: 72px; /* Para compensar la altura del footer */
        }
        
        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            font-size: 0.75rem;
            line-height: 1;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 0.5rem;
            color: inherit;
        }

        .footer-btn.active { color: var(--color-primary-dark); }

        /* Estilos para el JSON formateado dentro del modal (AJUSTADO PARA MEJOR WRAPPING) */
        #alert-message-container-wrapper {
            max-height: 250px; /* Aumentar ligeramente la altura m√°xima */
            overflow-y: auto;
            overflow-x: hidden; /* Asegurar que no haya scroll horizontal si el texto se ajusta */
            padding: 1rem; /* Padding uniforme */
        }
        #alert-message {
            white-space: pre-wrap; /* Mantiene saltos de l√≠nea y respeta el ancho del contenedor */
            word-break: break-word; /* Rompe palabras largas si es necesario */
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.8rem; /* Ligeramente m√°s grande */
            text-align: left;
        }
        
        /* * REGLA ACTUALIZADA PARA .form-label */
        .form-label {
            color: var(--color-label-gray); /* text-gray-300 */
            font-weight: 500; /* font-medium */
            font-size: 0.75rem; /* text-xs */
            display: block; 
            text-transform: uppercase; 
            margin-top: 0.5rem;
        }

        .form-input {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            border-radius: 0.5rem; 
            border-color: #4a5568; 
            background-color: var(--color-input-bg); 
            color: var(--color-text-dark);
            box-shadow: none;
            padding: 0.5rem;
            font-size: 0.875rem; 
            line-height: 1.25;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-input:focus {
            border-color: var(--color-primary-dark);
            outline: none;
            box-shadow: 0 0 0 1px var(--color-primary-dark);
        }
    </style>
</head>
<body class="dark transition-colors duration-300">

    <div id="app-container" class="shadow-xl">
        
        <header id="app-header" class="fixed top-0 w-full h-14 border-b border-gray-700 dark:border-gray-500 flex items-center justify-between px-4">
           <!-- El t√≠tulo inicial se establecer√° en JS con el nombre del usuario -->
           <h1 class="text-xl font-bold cursor-pointer hover:opacity-80 transition-opacity" onclick="loadContent('Inicio');">
                Mi Aplicaci√≥n M√≥vil DHO <!-- T√≠tulo de fallback -->
            </h1>
             <div class="flex space-x-3">
                  <!-- Bot√≥n de Cerrar Sesi√≥n con redirecci√≥n a index.html -->
                <button class="p-2 rounded-full hover:opacity-80 transition-opacity" onclick="window.location.href = 'index.html'">
                    <i data-lucide="log-out" class="w-6 h-6 text-red-400 dark:text-red-300"></i>
                </button>
             </div>
        </header>

        <!-- El contenido principal se carga aqu√≠ mediante JavaScript -->
        <main id="main-content" class="flex flex-col space-y-4">
            <!-- Contenido cargado din√°micamente -->
        </main>

        <footer id="app-footer" class="fixed bottom-0 w-full h-18 border-t border-gray-700 dark:border-gray-500 flex items-center justify-around py-2">
            
            <button class="footer-btn" data-section="Inicio">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span>Inicio</span>
            </button>
            
            <button class="footer-btn" data-section="Vacaciones">
                <i data-lucide="calendar-days" class="w-6 h-6"></i>
                <span>Vacaciones</span>
            </button>

            <!-- BOT√ìN AGREGAR: Establecido como activo por defecto -->
            <button class="footer-btn active" data-section="Agregar">
                <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                <span>Agregar</span>
            </button>
            
            <button class="footer-btn hidden" data-section="Editar">
                <i data-lucide="edit" class="w-6 h-6"></i>
                <span>Editar</span>
            </button>
            
            <button class="footer-btn" data-section="Perfil">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span>Perfil</span>
            </button>
            
            <button class="footer-btn" data-section="Configuraci√≥n">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span>Config</span>
            </button>
        </footer>
    </div>

    <!-- 
        VENTANA MODAL PERSONALIZADA
    -->
    <div id="custom-alert-modal" style="display: none;" 
         class="fixed inset-0 z-[100] bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-100 border border-gray-700">
            
            <!-- Encabezado del Modal -->
            <div id="alert-title-container" class="px-5 py-3 border-b border-gray-700 bg-blue-900 rounded-t-xl">
                <h3 id="alert-title" class="text-lg font-bold text-blue-300">T√≠tulo de la Alerta</h3>
            </div>
            
            <!-- Cuerpo del Mensaje -->
            <div class="p-2">
                <div id="alert-message-container-wrapper" class="bg-gray-700 border border-gray-600 rounded-lg text-gray-300">
                    <pre id="alert-message" class="text-xs"></pre>
                </div>
            </div>
            
            <!-- Pie de p√°gina/Bot√≥n de Cierre -->
            <div id="alert-footer" class="px-5 py-3 bg-gray-900 rounded-b-xl text-right border-t border-gray-700">
                <button id="alert-close-btn" onclick="document.getElementById('custom-alert-modal').style.display = 'none';"
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                    Aceptar
                </button>
            </div>
        </div>
    </div>


    <!-- 
        ------------------------------------------------------------------------------------------
        C√ìDIGO JAVASCRIPT
        ------------------------------------------------------------------------------------------
    -->
    <script>
        // Inicializaci√≥n de Lucide Icons (se llama en DOMContentLoaded y en loadContent)
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // ====================================================================================
        // *** 1. CONFIGURACI√ìN CR√çTICA: URL DE DESPLIEGUE DE GAS ***
        // ====================================================================================
        const POST_URL = "https://script.google.com/macros/s/AKfycbxjneZ_WpBjmIEAqtutJgk0m3oqsa0-OsmHjfPxBqZNfDb9gYzWV4kQ8hoXXIK5EAVnSA/exec"; 

        // ====================================================================================
        // *** 2. CONSTANTES DE CLAVE DE USUARIO Y TRANSFERENCIA EN LOCAL STORAGE ***
        // ====================================================================================
        const USUARIO_TIENDA_KEY = 'Usuario_Tienda';
        const USUARIO_NOMBRE_KEY = 'Usuario_Nombre'; 
        const USUARIO_PERFIL_KEY = 'Usuario_Perfil';
        const USUARIO_IDX_KEY = 'Usuario_Idx';
        
        // CLAVES DE TRANSFERENCIA COMPARTIDAS
        const EMPLOYEE_TRANSFER_KEY = 'userInfoToEdit';
        const REGISTER_TRANSFER_KEY = 'registerInfoToEdit'; // Registro de vacaciones a editar

        // ====================================================================================
        // *** 3. OBJETOS GLOBALES DE ESTADO ***
        // ====================================================================================
        let USER_INFO = {}; 
        
        /**
         * Variable que almacena el registro de vacaciones completo. 
         * En modo edici√≥n, se asume que contiene los datos originales del localStorage.
         */
        let currentVacationRecordToEdit = null;

        /**
         * Lee los datos del usuario logueado desde localStorage.
         */
        function initializeUserInfo() {
            USER_INFO.usuarioTienda = localStorage.getItem(USUARIO_TIENDA_KEY);
            USER_INFO.usuarioNombre = localStorage.getItem(USUARIO_NOMBRE_KEY);
            USER_INFO.usuarioPerfil = localStorage.getItem(USUARIO_PERFIL_KEY);
            USER_INFO.usuarioIdx = localStorage.getItem(USUARIO_IDX_KEY);

            const headerTitleEl = document.querySelector('#app-header .text-xl.font-bold');

            if (USER_INFO.usuarioNombre && headerTitleEl) {
                const names = USER_INFO.usuarioNombre.trim().split(/\s+/).filter(p => p.length > 0);
                const primerNombre = names[0] || '';
                
                if (primerNombre) {
                    USER_INFO.usuarioPrimerNombre = primerNombre; 
                    headerTitleEl.textContent = `¬°Hola, ${primerNombre}!`;
                } else {
                    headerTitleEl.textContent = 'Mi Aplicaci√≥n M√≥vil DHO';
                }
            } else if (headerTitleEl) {
                headerTitleEl.textContent = 'Mi Aplicaci√≥n M√≥vil DHO';
            }
            
            console.log("USER_INFO inicializado:", USER_INFO);
        }

        function getEmployeeInfo() {
            const defaultInfo = {
                CEDULA: 11222333, 
                INGRESO: '13/10/2015',
                NOMBRES: 'YXUISANA',
                APELLIDOS: 'HASTIYO',
            };
            
            try {
                const cachedData = localStorage.getItem(EMPLOYEE_TRANSFER_KEY);
                if (cachedData) {
                    const employeeInfo = JSON.parse(cachedData);
                    if (employeeInfo && employeeInfo.CEDULA) {
                        return { ...defaultInfo, ...employeeInfo }; 
                    }
                }
            } catch (error) {
                console.error("Error al parsear los datos del empleado desde localStorage, usando mock:", error);
            }
            return defaultInfo;
        }

        const MOCK_EMPLOYEE_INFO = getEmployeeInfo();

        // ====================================================================================
        // *** 4. ESTRUCTURA HTML DEL FORMULARIO DE VACACIONES (SIN CAMBIOS) ***
        // ====================================================================================
        const VACACIONES_FORM_STRUCTURE = `
            <form id="vacation-form" class="space-y-4">
                
                <div class="p-5 bg-gray-800 rounded-xl shadow-lg border border-gray-700 mt-4">
                    
                    <div class="flex justify-between items-start mb-3 pb-2 border-b border-gray-700">
                        <h3 class="text-xl font-extrabold text-white leading-tight" id="display-employee-name">
                            {{EMPLOYEE_NAME}}
                        </h3>
                        <button type="button" onclick="loadContent('Vacaciones')" class="p-1 rounded-full text-red-400 hover:text-red-600 transition duration-150">
                            <i data-lucide="x" class="w-6 h-6 icon-x relative -mt-4 -mr-4"></i> 		
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-start text-sm text-gray-400 space-x-1">
                            <i data-lucide="factory" class="w-6 h-6 text-blue-400/90 flex-shrink-0"></i>
                            <h3 class="p-1 text-sm font-extrabold text-white leading-tight" id="display-empresa">   
                                {{EMPRESA}}
                            </h3>
                        </div>

                        <div class="text-right">
                            <div class="flex flex-col items-end">
                                <span class="text-sm text-gray-400 font-semibold">C√©dula: <span class="text-gray-300" id="display-cedula">{{CEDULA_FORMATTED}}</span></span>
                                <span class="text-sm text-gray-400 font-semibold">Ingreso: <span class="text-gray-300" id="display-ingreso">{{INGRESO}}</span></span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="form-nombres-apellidos" name="NOMBRE_EMPLEADO" autocomplete="off">
                    <input type="hidden" id="form-cedula" name="CEDULA" autocomplete="off">
                    <input type="hidden" id="form-ingreso" name="INGRESO" autocomplete="off">

                </div>

                <div class="p-5 bg-gray-900 rounded-xl shadow-lg border border-gray-700">
                    
                    <h2 class="text-xl font-bold text-yellow-300 mb-4 pb-2 flex items-center" id="form-title-wrapper"> 
                        <span id="form-title-text">Detalles de Solicitud</span>
                        <button type="button" 
                                onclick="toggleVacationLock()" 
                                class="ml-2 p-1 rounded-full text-gray-400 hover:bg-gray-700 transition duration-150 hidden" 
                                id="vacacion-condicion-button" 
                                title="Bloquear/Desbloquear Solicitud">
                            <i data-lucide="lock-open" class="w-6 h-6" id="vacacion-condicion-icon"></i>
                        </button>
                    </h2>
                    
                    <div>
                        <label for="form-periodo" class="form-label">PER√çODO *</label>
                        <input type="text" id="form-periodo" name="PERIODO" required placeholder="Ej: 2024"
                            autocomplete="off" class="form-input">
                    </div>

                    <div>
                        <label for="form-concepto" class="form-label">CONCEPTO / DESCRIPCI√ìN *</label>
                        <textarea id="form-concepto" name="DESCRIPCION_CONCEPTO" rows="2" required
                                    placeholder="Motivo detallado de la solicitud"
                                    autocomplete="off" class="form-input"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div>
                            <label for="form-dia-ini" class="form-label">D√çA INICIO *</label>
                            <input type="date" id="form-dia-ini" name="DIA_INICIO" required
                                autocomplete="off" class="form-input">
                        </div>
                        <div>
                            <label for="form-dia-fin" class="form-label">D√çA FINAL *</label>
                            <input type="date" id="form-dia-fin" name="DIA_FINAL" required
                                autocomplete="off" class="form-input">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        
                        <div>
                            <label for="dias-vacaciones-display-input" class="form-label">D√çAS VACACIONES</label>
                            <input type="text" id="dias-vacaciones-display-input" readonly value="0"
                                autocomplete="off" class="form-input !bg-gray-700 border-gray-600 cursor-default">
                            
                            <input type="hidden" id="form-dias" name="DIAS_VACACIONES" value="0" autocomplete="off">
                            <p id="dias-habiles-info" class="text-xs text-gray-400 mt-1">
                                Calculado autom√°ticamente <br> (d√≠as h√°biles).
                            </p>
                        </div>

                        <div>
                            <label for="form-bono" class="form-label">BONO VACACIONAL</label>
                            <input type="text" id="form-bono" name="BONO_VACACIONAL" value="0"
                                placeholder="0"
                                autocomplete="off" class="form-input">
                        </div>
                    </div>
                    
                    <button type="button" onclick="sendDataToGas();" 
                            id="submit-btn"
                            class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01] mt-6 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center space-x-2 justify-center">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            <span id="button-text">Guardar Registro</span>
                        </span>
                    </button>
                </div>
            </form>
        `;

        // --- FUNCIONES DE UTILIDAD (SIN CAMBIOS) ---
        function formatNumberWithDots(value) { /* ... */
            if (value === null || value === undefined || value === '') return '';
            let numStr = String(value).replace(/\D/g, '');
            return new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(Number(numStr));
        }
        
        function showCustomAlert(title, message, isError = false, isDismissible = true, callback = null) {
            const modal = document.getElementById('custom-alert-modal');
            const titleEl = document.getElementById('alert-title');
            const messageEl = document.getElementById('alert-message');
            const alertFooter = document.getElementById('alert-footer');
            const closeBtn = document.getElementById('alert-close-btn');

            if (!modal || !titleEl || !messageEl || !alertFooter || !closeBtn) {
                console.error("ERROR CR√çTICO: No se encontraron los elementos esenciales del modal.");
                return; 
            }
            
            const titleContainer = titleEl.parentElement; 
            const messageContainerWrapper = document.getElementById('alert-message-container-wrapper');

            // --- L√ìGICA DE VISIBILIDAD DEL BOT√ìN ---
            if (isDismissible) {
                alertFooter.style.display = 'block'; 
                modal.classList.remove('pointer-events-none'); 
                
                closeBtn.onclick = () => {
                    hideCustomAlert();
                    if (callback) callback();
                };
                
            } else {
                alertFooter.style.display = 'none'; 
                modal.classList.add('pointer-events-none'); 
            }

            // --- L√ìGICA DE ESTILOS Y CONTENIDO ---
            titleEl.textContent = title;
            
            if (isError) {
                titleContainer.classList.remove('bg-blue-900');
                titleContainer.classList.add('bg-red-900');
                titleEl.classList.remove('text-blue-300');
                titleEl.classList.add('text-red-300');
                closeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                closeBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                messageContainerWrapper.classList.remove('bg-gray-700', 'border-gray-600');
                messageContainerWrapper.classList.add('bg-red-950', 'border-red-600');
            } else {
                titleContainer.classList.add('bg-blue-900');
                titleContainer.classList.remove('bg-red-900');
                titleEl.classList.add('text-blue-300');
                titleEl.classList.remove('text-red-300');
                closeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                closeBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                messageContainerWrapper.classList.add('bg-gray-700', 'border-gray-600');
                messageContainerWrapper.classList.remove('bg-red-950', 'border-red-600');
            }
            
            if (typeof message === 'object' && message !== null) {
                messageEl.textContent = JSON.stringify(message, null, 2);
                messageEl.style.fontSize = '0.75rem'; 
            } else {
                messageEl.textContent = String(message);
                messageEl.style.fontSize = '0.9rem'; 
            }
            
            modal.style.display = 'flex';
        }
        
        function hideCustomAlert() {
            const modal = document.getElementById('custom-alert-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('pointer-events-none');
                
                const closeBtn = document.getElementById('alert-close-btn');
                if(closeBtn) {
                    closeBtn.onclick = () => {
                        document.getElementById('custom-alert-modal').style.display = 'none';
                    };
                }
            }
        }

        function objectToUrlEncoded(obj) {
            const params = [];
            for (const key in obj) {
                if (obj.hasOwnProperty(key) && obj[key] !== undefined && obj[key] !== null) {
                    const encodedKey = encodeURIComponent(key);
                    const encodedValue = encodeURIComponent(String(obj[key]).trim()); 
                    params.push(`${encodedKey}=${encodedValue}`);
                }
            }
            return params.join('&');
        }

        // --- 5. FUNCIONES AUXILIARES DE GESTI√ìN DE ESTADO (MANTENIDAS) ---

        function fillFormFieldsFromRecord(record) {
            // Periodo, Concepto
            document.getElementById('form-periodo').value = record.PERIODO || '';
            document.getElementById('form-concepto').value = record.DESCRIPCION_CONCEPTO || '';
            
            // Bono Vacacional (Quitar separadores de miles antes de ponerlo en el input)
            const rawBono = String(record.BONO_VACACIONAL || 0).replace(/\./g, '').replace(/,/g, '');
            document.getElementById('form-bono').value = rawBono; 

            // Fechas (Convertir a formato YYYY-MM-DD)
            document.getElementById('form-dia-ini').value = formatInputDate(record.DIA_INICIO); 
            document.getElementById('form-dia-fin').value = formatInputDate(record.DIA_FINAL);
            
            // D√≠as de Vacaciones se rellena con el valor almacenado.
            document.getElementById('dias-vacaciones-display-input').value = record.DIAS_VACACIONES || 0;
            document.getElementById('form-dias').value = record.DIAS_VACACIONES || 0;
        }

        function updateLockIconUI(condicion) {
            const condicionIconEl = document.getElementById('vacacion-condicion-icon');

            if (!condicionIconEl) return;

            if (condicion === 'Bloqueada') {
                condicionIconEl.setAttribute('data-lucide', 'lock');
                condicionIconEl.classList.remove('text-green-400', 'text-gray-400', 'text-red-400');
                condicionIconEl.classList.add('text-red-400'); // Bloqueada: Rojo
            } else {
                condicionIconEl.setAttribute('data-lucide', 'lock-open');
                condicionIconEl.classList.remove('text-red-400', 'text-gray-400', 'text-green-400');
                condicionIconEl.classList.add('text-green-400'); // Registrada/Otro: Verde
            }
            
            // Re-renderizar Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function applyFormReadonlyState(isLocked) {
            const fieldsToLock = [
                'form-periodo', 'form-concepto', 'form-dia-ini', 'form-dia-fin', 'form-bono'
            ];
            
            fieldsToLock.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'form-dia-ini' || id === 'form-dia-fin') {
                        el.removeEventListener('change', updateDaysField); 
                    }

                    if (isLocked) {
                        el.setAttribute('readonly', true);
                        el.classList.add('cursor-not-allowed', 'opacity-50', 'bg-gray-700/50');
                    } else {
                        el.removeAttribute('readonly');
                        el.classList.remove('cursor-not-allowed', 'opacity-50', 'bg-gray-700/50');
                        if (id === 'form-dia-ini' || id === 'form-dia-fin') {
                            el.addEventListener('change', updateDaysField);
                        }
                    }
                }
            });
        }

        function fillFormForEditing(record) {
            console.log("Rellenando formulario para edici√≥n.");

            const buttonTextEl = document.getElementById('button-text');
            const formTitleTextEl = document.getElementById('form-title-text');
            const condicionButton = document.getElementById('vacacion-condicion-button');
            const diasDisplayInput = document.getElementById('dias-vacaciones-display-input');

            if (buttonTextEl) buttonTextEl.textContent = 'Actualizar Registro';
            if (formTitleTextEl) {
                formTitleTextEl.textContent = 'Actualizar Solicitud';
                formTitleTextEl.classList.remove('text-yellow-300');
                formTitleTextEl.classList.add('text-blue-400');
            }
            
            if (condicionButton) condicionButton.classList.remove('hidden');

            fillFormFieldsFromRecord(record);
            
            const isInitiallyBlocked = record.VACACION_CONDICION === 'Bloqueada';
            
            applyFormReadonlyState(isInitiallyBlocked);
            
            updateLockIconUI(record.VACACION_CONDICION);
            
            if (diasDisplayInput) {
                diasDisplayInput.setAttribute('readonly', true);
                diasDisplayInput.classList.add('cursor-not-allowed', 'opacity-75'); 
                diasDisplayInput.classList.remove('bg-gray-700/50'); 
            }

            localStorage.removeItem(REGISTER_TRANSFER_KEY); 
        }

        function toggleVacationLock() {
            if (!currentVacationRecordToEdit) {
                console.error("No se puede bloquear/desbloquear: No est√° en modo edici√≥n.");
                return;
            }

            const currentCondition = currentVacationRecordToEdit.VACACION_CONDICION;
            let newCondition;
            let originalCondition = currentVacationRecordToEdit.ORIGINAL_CONDICION || 'Registrada';

            if (currentCondition !== 'Bloqueada') {
                currentVacationRecordToEdit.ORIGINAL_CONDICION = currentCondition;
                newCondition = 'Bloqueada';
                showCustomAlert("Solicitud Bloqueada üîí", "El registro ha sido marcado como **Bloqueado**. Los campos han sido restablecidos y solo un Administrador puede Desbloquear.", false);
                
            } else {
                const userProfile = USER_INFO.usuarioPerfil;
                const userIdx = USER_INFO.usuarioIdx;

                if (userProfile !== 'Admin') {
                    showCustomAlert("Acceso Denegado ‚ùå", "Solo los usuarios con perfil **'Admin'** pueden desbloquear las solicitudes.", true);
                    applyFormReadonlyState(true);
                    updateLockIconUI('Bloqueada');
                    return;
                }

                const adminKey = prompt("Por favor, ingrese su clave de administrador para desbloquear (USUARIO_IDX_KEY):");
                
                if (adminKey !== userIdx) {
                    showCustomAlert("Clave Incorrecta üîë", "La clave de administrador ingresada es incorrecta. La solicitud permanece **Bloqueada**.", true);
                    applyFormReadonlyState(true);
                    updateLockIconUI('Bloqueada');
                    return;
                }

                newCondition = originalCondition; 
                showCustomAlert("Solicitud Desbloqueada üîì", "El registro ha sido **Desbloqueado** por un Administrador. Ahora puedes modificar los campos.", false);
            }

            currentVacationRecordToEdit.VACACION_CONDICION = newCondition;

            const isLocked = newCondition === 'Bloqueada';
            applyFormReadonlyState(isLocked);
            
            if (isLocked) {
                fillFormFieldsFromRecord(currentVacationRecordToEdit); 
            } else {
                updateDaysField();
            }
            
            updateLockIconUI(newCondition);
        }

        // --- C√ÅLCULO DE D√çAS H√ÅBILES Y UTILIDADES DE FECHA ---
        function getTodayDateString() { 
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatInputDate(dateString) { 
            if (!dateString) return '';
            const parts = dateString.split(/[-\/]/); 
            if (parts.length === 3) {
                if (parts[0].length === 4) {
                    return dateString;
                }
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateString;
        }
        function formatDateForDisplay(dateString) { 
            if (!dateString) return 'N/A';
            const parts = dateString.split(/[-\/]/); 
            if (parts.length === 3) {
                if (parts[0].length === 4) { 
                    return `${parts[2]}/${parts[1]}/${parts[0]}`; 
                }
                return dateString; 
            }
            return dateString;
        }
        function formatEmployeeName(nombres, apellidos) { 
            let formattedName = 'Empleado Desconocido';
            if (nombres && apellidos) {
                const names = String(nombres).trim().split(/\s+/).filter(p => p.length > 0);
                const firstName = names[0] || '';
                const middleInitial = names.length > 1 ? names[1].charAt(0) + '.' : '';
                const surnames = String(apellidos).trim().split(/\s+/).filter(p => p.length > 0);
                const firstSurname = surnames[0] || '';
                const lastInitial = surnames.length > 1 ? surnames[1].charAt(0) + '.' : '';
                formattedName = `${firstName} ${middleInitial} ${firstSurname} ${lastInitial}`.replace(/\s{2,}/g, ' ').trim();
            }
            return formattedName;
        }

        /**
         * CORRECCI√ìN DE LA FUNCI√ìN: Se modific√≥ para usar el constructor de componentes Date(Y, M-1, D)
         * en lugar de parsear la cadena 'YYYY-MM-DD' para evitar el desplazamiento de zona horaria 
         * en el lado del cliente.
         */
        function calculateBusinessDays(start, end) { 
            if (!start || !end) return 0;
            
            // 1. Parsear los componentes de la fecha del input 'YYYY-MM-DD'
            let [startY, startM, startD] = start.split('-').map(n => parseInt(n, 10));
            let [endY, endM, endD] = end.split('-').map(n => parseInt(n, 10));

            // 2. Crear objetos Date a medianoche en la zona horaria local. (M-1 es crucial)
            let startDate = new Date(startY, startM - 1, startD); 
            let endDate = new Date(endY, endM - 1, endD);

            if (startDate > endDate) return 0;
            
            let count = 0;
            let currentDate = new Date(startDate);
            
            // 3. Iterar d√≠a por d√≠a
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay(); // 0 (Sunday) to 6 (Saturday)
                
                // Si no es Domingo (0) ni S√°bado (6), es un d√≠a h√°bil
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { 
                    count++;
                }
                // Mover al siguiente d√≠a. setDate() es seguro contra desbordamiento de mes.
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        };

        function updateDaysField() { 
            const inicioInput = document.getElementById('form-dia-ini');
            const finInput = document.getElementById('form-dia-fin');
            const diasInputHidden = document.getElementById('form-dias'); 
            const diasInputDisplay = document.getElementById('dias-vacaciones-display-input'); 
            const infoText = document.getElementById('dias-habiles-info');

            if (!inicioInput || !finInput || !diasInputHidden || !diasInputDisplay || !infoText) return;
            
            if (inicioInput.hasAttribute('readonly') || finInput.hasAttribute('readonly')) {
                return;
            }

            const start = inicioInput.value;
            const end = finInput.value;
            
            infoText.classList.remove('text-red-400');
            infoText.classList.add('text-gray-400');
            diasInputDisplay.classList.remove('!border-red-500');

            if (start && end) {
                const businessDays = calculateBusinessDays(start, end);
                
                if (businessDays > 0) {
                    diasInputDisplay.value = businessDays;
                    diasInputHidden.value = businessDays;
                    infoText.innerHTML = 'Calculado autom√°ticamente <br> (d√≠as h√°biles).';
                } else if (businessDays === 0) {
                    diasInputDisplay.value = 0;
                    diasInputHidden.value = 0;
                    diasInputDisplay.classList.add('!border-red-500'); 
                    
                    if (new Date(start) > new Date(end)) {
                        infoText.textContent = 'ERROR: Fechas invertidas o inv√°lidas.';
                    } else {
                        infoText.textContent = '¬°0 d√≠as h√°biles! Verifica que no sean solo fines de semana.';
                    }
                    infoText.classList.add('text-red-400');
                }

            } else {
                diasInputDisplay.value = 0;
                diasInputHidden.value = 0;
                infoText.innerHTML = 'Calculado autom√°ticamente <br> (d√≠as h√°biles).';
            }
        }
        
        function setLoadingState(isLoading) { 
            const submitBtn = document.getElementById('submit-btn');
            const buttonText = document.getElementById('button-text');
            
            if (!submitBtn || !buttonText) return;

            submitBtn.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Enviando...';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-gray-500'); 
            } else {
                const isEditMode = currentVacationRecordToEdit !== null;
                
                buttonText.textContent = isEditMode ? 'Actualizar Registro' : 'Guardar Registro'; 
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.remove('bg-gray-500');
                
                submitBtn.disabled = false;
            }
        }


        // --- 6. FUNCI√ìN PRINCIPAL DE ENV√çO A GAS (ACTUALIZADA para mostrar VacationID) ---

        async function sendDataToGas() {
            const isEditMode = currentVacationRecordToEdit !== null;
            const isBlocked = isEditMode && currentVacationRecordToEdit.VACACION_CONDICION === 'Bloqueada';
            
            // Obtener la informaci√≥n del empleado
            const EMPLOYEE_TRANSFER_KEY = 'userInfoToEdit';
            const workerInfoJSON = localStorage.getItem(EMPLOYEE_TRANSFER_KEY);
            const workerInfo = workerInfoJSON ? JSON.parse(workerInfoJSON) : {};

            if (!workerInfo.CEDULA) {
                setLoadingState(false);
                showCustomAlert("Error de Datos", "No se encontr√≥ la informaci√≥n del empleado seleccionado. Vuelve a la vista de Vacaciones.", true);
                return;
            }
            
            // Definir nombres y apellidos ANTES de que se usen en dataToSend
            const nombres = workerInfo.NOMBRES || '';
            const apellidos = workerInfo.APELLIDOS || '';
            const formattedEmployeeName = formatEmployeeName(nombres, apellidos); 

            const form = document.getElementById('vacation-form');
            
            // 1. VALIDACIONES DE FORMULARIO
            if (!isBlocked) {
                if (!form.checkValidity()) {
                    form.reportValidity(); 
                    return;
                }

                const periodoInput = document.getElementById('form-periodo');
                const diasInput = document.getElementById('form-dias');
                
                const periodo = Number(periodoInput.value);
                const diasVacaciones = Number(diasInput.value);

                if (periodo < 2020 || periodo >= 2040) {
                    showCustomAlert("Error de Per√≠odo", "El campo PER√çODO debe ser un a√±o entre 2020 y 2039.", true);
                    periodoInput.focus();
                    return;
                }
                
                if (diasVacaciones < 1) {
                    showCustomAlert("Error de D√≠as", "El n√∫mero de D√≠as de Vacaciones calculados debe ser igual o mayor a 1. Por favor, verifica que la fecha fin sea siempre mayor a la fecha inicio.", true);
                    document.getElementById('form-dia-ini').focus(); 
                    return;
                }
            }
            
            setLoadingState(true);

            // 2. CONSTRUCCI√ìN DE DATA
            const formData = new FormData(form);
            const dataToSend = {}; // üõë DECLARACI√ìN E INICIALIZACI√ìN DE dataToSend (Soluci√≥n al error)
            
            for (const [key, value] of formData.entries()) {
                const trimmedValue = (typeof value === 'string') ? value.trim() : value;
                let processedValue = trimmedValue;

                if (key === 'BONO_VACACIONAL' || key === 'PERIODO') {
                    processedValue = String(trimmedValue).replace(/\./g, '').replace(/,/g, '');
                }

                if (['CEDULA', 'DIAS_VACACIONES', 'BONO_VACACIONAL', 'PERIODO'].includes(key)) {
                    dataToSend[key] = Number(processedValue) || 0;
                } else {
                    dataToSend[key] = processedValue;
                }
            }

            // El error 'dataToSend is not defined' ocurr√≠a si la l√≠nea const dataToSend = {}; se saltaba.
            dataToSend['NOMBRES'] = nombres;
            dataToSend['APELLIDOS'] = apellidos;
            dataToSend['NOMBRE_EMPLEADO'] = formattedEmployeeName;
            dataToSend['INGRESO'] = workerInfo.INGRESO || 'N/A';
            dataToSend['EMPRESA'] = workerInfo.EMPRESA || ''; 
            dataToSend['RegistroDate'] = new Date().toISOString().split('T')[0]; 
            dataToSend['TIENDA'] = USER_INFO.usuarioTienda || 'N/A';
            dataToSend['PERFIL'] = USER_INFO.usuarioPerfil || 'N/A';
            dataToSend['IDX'] = USER_INFO.usuarioIdx || '0';
            dataToSend['RegistroUser'] = USER_INFO.usuarioNombre || 'Usuario Desconocido'; 
            
            // üõë ACCI√ìN UNIFICADA: Siempre 'register_vacation'
            dataToSend['action'] = 'register_vacation';

            let successMessage;

            // 3. L√ìGICA DE ACTUALIZACI√ìN VS NUEVO (DIFERENCIADO POR CAMPOS ADICIONALES)
            if (isEditMode) {
                dataToSend['ROW_INDEX'] = currentVacationRecordToEdit.ROW_INDEX || ''; 
                dataToSend['ORIGINAL_PERIODO'] = currentVacationRecordToEdit.PERIODO;
                dataToSend['ORIGINAL_DIA_INICIO'] = currentVacationRecordToEdit.DIA_INICIO;

                const currentCondition = currentVacationRecordToEdit.VACACION_CONDICION;
                
                if (currentCondition === 'Bloqueada') {
                    dataToSend['VACACION_CONDICION'] = 'Bloqueada'; 
                } else {
                    dataToSend['VACACION_CONDICION'] = 'Actualizada';
                }
                
                dataToSend['ORIGINAL_CONDICION'] = currentVacationRecordToEdit.ORIGINAL_CONDICION || 'Registrada'; 
                
                successMessage = 'Los datos se han actualizado correctamente en la hoja de c√°lculo.';
                
            } else {
                // L√≥gica de Nuevo Registro
                dataToSend['ROW_INDEX'] = ''; 
                dataToSend['VACACION_CONDICION'] = 'Registrada'; 
                successMessage = 'Los datos se han registrado correctamente ';
            }

            console.log('Datos finales a enviar:', dataToSend);

            // 4. ENV√çO REAL A GAS
            const urlEncodedBody = objectToUrlEncoded(dataToSend);

            try {
                showCustomAlert("Enviando Datos...", "Intentando conectar con Google Apps Script. Por favor, espere.", false, false);

                const response = await fetch(POST_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: urlEncodedBody 
                });
                
                const gasResponseText = await response.text(); 
                hideCustomAlert();
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${gasResponseText}`);
                }

                try {
                    const result = JSON.parse(gasResponseText);
                    
                    if (result.success) {
                        
                        let finalMessage = successMessage;
                        // Agregamos el ID de vacaciones si se devuelve desde GAS
                        if (result.vacationId) {
                            finalMessage += `en el documento ${result.vacationId}`;
                        }

                        showCustomAlert("¬°√âxito en la Operaci√≥n!", 
                            finalMessage,
                            false, 
                            true, 
                            () => {
                                window.location.href = 'Vacaciones.html?reload=true';
                            }
                        ); 
                    } else {
                        showCustomAlert("Error de L√≥gica en GAS", {
                            'STATUS': 'ERROR INTERNO',
                            'MENSAJE': result.message || 'El script de Google Apps Script fall√≥ en el registro/actualizaci√≥n.',
                        }, true);
                    }
                } catch (e) {
                    showCustomAlert("Operaci√≥n Enviada (Verificar)", {
                        'STATUS': 'VERIFICACI√ìN NECESARIA',
                        'MENSAJE': 'La solicitud se envi√≥, pero la respuesta del servidor no fue JSON. Verifique su hoja de c√°lculo.',
                        'DETALLE_RAW': gasResponseText.substring(0, 200) + '...',
                    });
                }

            } catch (error) {
                hideCustomAlert(); 
                showCustomAlert("Error Cr√≠tico de Conexi√≥n", {
                    'STATUS': 'ERROR CR√çTICO',
                    'MENSAJE': `No se pudo conectar. Verifica la URL de GAS o tu conexi√≥n de red.`,
                    'DETALLE_ERROR': error.message,
                }, true); 
            } finally {
                setLoadingState(false);
            }
        }
        
        // --- 7. L√ìGICA DE NAVEGACI√ìN Y CARGA (SIN CAMBIOS FUNCIONALES) ---
        
        function setActiveFooterButton(sectionName) { 
            document.querySelectorAll('#app-footer .footer-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-section') === sectionName) {
                    btn.classList.add('active');
                }
            });
        }

        /**
        * Limpia todas las claves de cach√© de datos de la aplicaci√≥n antes de cerrar sesi√≥n.
        * Incluye las claves de BD_Personal2 y Vacaciones2, y limpia cualquier dato de usuario.
        */
        function logoutAndClearCache() {
            // Definir las claves que deben ser eliminadas
            const cacheKeys = [
                'employeeDataCache_BD_Personal2', // Cach√© de BD_Personal2
                'vacaciones2DataCache',           // Cach√© de Vacaciones2
                'Usuario_Nombre',                 // Opcional: limpiar datos de sesi√≥n como el nombre
                // Agrega aqu√≠ cualquier otra clave de localStorage que desees limpiar
            ];

            // Limpiar cada clave
            cacheKeys.forEach(key => {
                localStorage.removeItem(key);
                console.log(`Cach√© limpia: ${key}`);
            });

            // Redirigir al usuario a la p√°gina de inicio (index.html)
            window.location.href = 'index.html';
        }
        
        function loadContent(section) {
            const mainContent = document.getElementById('main-content');
            
            setActiveFooterButton(section);

            if (section === 'Inicio') {
                window.location.href = 'Inicio.html';
                return;
            }
            
            if (section === 'Vacaciones') {
                window.location.href = 'Vacaciones.html';
                return;
            }

            if (section === 'Editar') {
                window.location.href = 'EditarDat.html';
                return;
            }

            if (section === 'Perfil') {
                window.location.href = 'PerfilUser.html';
                return;
            }

            if (section === 'Configuraci√≥n') {
                window.location.href = 'ConfigApp.html';
                return;
            }
            
            if (section === 'Agregar') {
                
                const recordToEditJSON = localStorage.getItem(REGISTER_TRANSFER_KEY);
                let isEditMode = false;
                
                if (recordToEditJSON) {
                    try {
                        const record = JSON.parse(recordToEditJSON);
                        if (!record.ORIGINAL_CONDICION) {
                            record.ORIGINAL_CONDICION = record.VACACION_CONDICION;
                        }
                        currentVacationRecordToEdit = record;
                        isEditMode = true;
                    } catch (e) {
                        console.error("Error al parsear el registro de edici√≥n:", e);
                        localStorage.removeItem(REGISTER_TRANSFER_KEY); 
                        currentVacationRecordToEdit = null;
                    }
                } else {
                    currentVacationRecordToEdit = null;
                }

                mainContent.innerHTML = ''; 

                const nameDisplay = formatEmployeeName(MOCK_EMPLOYEE_INFO.NOMBRES, MOCK_EMPLOYEE_INFO.APELLIDOS); 
                const cedulaDisplayFormatted = formatNumberWithDots(MOCK_EMPLOYEE_INFO.CEDULA); 
                const cedulaDisplayRaw = String(MOCK_EMPLOYEE_INFO.CEDULA || 'N/A'); 
                const ingresoDisplay = formatDateForDisplay(MOCK_EMPLOYEE_INFO.INGRESO);
                const empresaDisplay = MOCK_EMPLOYEE_INFO.EMPRESA || 'N/A'; 
                const fullNameForHidden = `${MOCK_EMPLOYEE_INFO.NOMBRES || ''} ${MOCK_EMPLOYEE_INFO.APELLIDOS || ''}`.trim();

                let contentHTML = VACACIONES_FORM_STRUCTURE
                    .replace('{{EMPLOYEE_NAME}}', nameDisplay)
                    .replace('{{CEDULA_FORMATTED}}', cedulaDisplayFormatted) 
                    .replace('{{INGRESO}}', ingresoDisplay)
                    .replace('{{EMPRESA}}', empresaDisplay);

                mainContent.innerHTML = contentHTML;
                
                document.getElementById('form-nombres-apellidos').value = fullNameForHidden;
                document.getElementById('form-cedula').value = cedulaDisplayRaw; 
                document.getElementById('form-ingreso').value = ingresoDisplay;
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                if (isEditMode) {
                    fillFormForEditing(currentVacationRecordToEdit); 
                    
                    document.getElementById('form-dia-ini').addEventListener('change', updateDaysField);
                    document.getElementById('form-dia-fin').addEventListener('change', updateDaysField);

                } else {
                    // Modo Nuevo Registro:
                    const buttonTextEl = document.getElementById('button-text');
                    const formTitleTextEl = document.getElementById('form-title-text');
                    const condicionButton = document.getElementById('vacacion-condicion-button');
                    const diasDisplayInput = document.getElementById('dias-vacaciones-display-input');

                    if (buttonTextEl) buttonTextEl.textContent = 'Guardar Registro';
                    if (formTitleTextEl) {
                        formTitleTextEl.textContent = 'Detalles de Solicitud';
                        formTitleTextEl.classList.remove('text-blue-400');
                        formTitleTextEl.classList.add('text-yellow-300');
                    }
                    
                    if (condicionButton) condicionButton.classList.add('hidden');
                    
                    if (diasDisplayInput) {
                        diasDisplayInput.removeAttribute('readonly');
                        diasDisplayInput.classList.remove('cursor-not-allowed', 'opacity-75'); 
                    }

                    const todayDate = getTodayDateString();
                    document.getElementById('form-dia-ini').value = todayDate;
                    document.getElementById('form-periodo').value = new Date().getFullYear().toString();
                    document.getElementById('form-concepto').value = ''; 
                    document.getElementById('form-dia-fin').value = ''; 
                    document.getElementById('form-bono').value = ''; 
                    
                    document.getElementById('form-dia-ini').addEventListener('change', updateDaysField);
                    document.getElementById('form-dia-fin').addEventListener('change', updateDaysField);
                    updateDaysField();
                }
                
                return;
            }
            
            mainContent.innerHTML = 'Contenido de Inicio'; 
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // --- 8. INICIALIZACI√ìN DE LA APLICACI√ìN (SIN CAMBIOS) ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeUserInfo();

            document.querySelectorAll('#app-footer .footer-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const section = button.getAttribute('data-section');
                    if (section) {
                        loadContent(section);
                    }
                });
            });

            const initialSection = document.querySelector('.footer-btn.active')?.getAttribute('data-section') || 'Agregar';
            loadContent(initialSection);
        });

    </script>
</body>
</html>
